# Volume encryption with EncFS

## Overview
Protecting sensitive files with Unbound MPC technology is possible using [EncFS](https://en.wikipedia.org/wiki/EncFS).

EncFS provides transparent file encryption for an arbitrary volume and is supported by many platforms. The volume can be mounted to any media supported by the host including cloud volumes like [Amazom EBS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html) 

Files are encrypted using a volume key and a password is used to decrypt that key.

This guide provides instructions and scripts for using Unbound MPC technology to protect the volume encryption key password. 
This provides the following benefits:
* Strong password protection with MPC technology
* Key rotation for increased security 

## Prerequisites
1. A working [Unbound CORE KMS](https://www.unboundsecurity.com/docs/TechDocs/Unbound_Doc_Versions-HTML/Content/Products/UnboundDocLibrary/Technical_Document_Versions.htm#UKC) server
2. The client machine should have
   1. EncFS package installed
   2. For communications with Unbound CORE server, either of these two options:
      1. For communications using [CORE REST API](http://www.unboundsecurity.com/docs/ukc_rest/ukc.html) 
         For this option **curl** should be installed.  
         This option is easier to deploy but may be less secure.
      1. For communications using Unbound CORE Client, The CORE Client package should be installed.  
         This option is more secure but requires [installation and configuration of Unbound CORE Client](https://www.unboundsecurity.com/docs/UKC/UKC_Installation/Content/Products/UKC-EKM/UKC_User_Guide/UG-Inst/ClientInstallation.html)
## Prepare the encryption key
The first step is to [create an RSA key with Unbound CORE KMS](https://www.unboundsecurity.com/docs/UKC/UKC_Interfaces/Content/Products/UKC-EKM/UKC_User_Guide/UG-If/uiSO/KeyTab.html#Create2).
This key is used for encrypting the EncFS volume password.
Unbound KMS stores keys in segregated containers called Partitions so the first step is to [create and configure a partition](https://www.unboundsecurity.com/docs/UKC/UKC_Interfaces/Content/Products/UKC-EKM/UKC_User_Guide/UG-If/uiRoot/PartitionsTab.html#Create) for our key. This step can be skipped if you already have an existing partition you want to use.

The preparation steps in this section should be carried out by an Unbound CORE Administrator (SO) user. They can be done from Unbound [CORE Web Admin (UI)](https://www.unboundsecurity.com/docs/UKC/UKC_Interfaces/Content/Products/UKC-EKM/UKC_User_Guide/UG-If/uiSO/SoUI.html#top) or by using a script with [Unbound CLI](https://www.unboundsecurity.com/docs/UKC/UKC_Interfaces/Content/Products/UKC-EKM/UKC_User_Guide/UG-If/cliIntro.html#h1_1), called `ucl` as follows:

```
# Set the partition name - you may change it or use existing partition
PARTITION_NAME=encfs 
# Set the partition administrator(usename so) password
PARTITION_ADMIN_PASSWORD=<use a strong password> 
# Create the partition if necessary
sudo ucl partition create -p $PARTITION_NAME -w Password1! -s Password1

# Create an RSA key for encryption. You may change the key name.
ENCFS_KEY_NAME=encfskey
ucl generate -t RSA -p $PARTITION_NAME --name $ENCFS_KEY_NAME

# Create a partition user with restricted permissions only for crypto operations.
PARTITION_CRYPTO_USER_NAME=encfs_user
PARTITION_CRYOTO_USER_PASSWORD=<replace with a strong password>
ucl user create -p $PARTITION_NAME -n $PARTITION_CRYPTO_USER_NAME -d $PARTITION_CRYOTO_USER_PASSWORD -w PARTITION_ADMIN_PASSWORD -r user
```
## Configuration
The `ub-get-password` script uses the following environment variables
* UB_PARTITION - The partition containing the encryption key. Defaults to `encfs`
* UB_KEY_NAME  - The name of the key to use for encryption. Must be an RSA key in UB_PARTITION, with Decrypt operation permission.
* UB_USER - The partition user - must be a user with permissions for Decrypt for the encryption key. Defaults to `user`
* UB_USER_PASSWORD - The partition user password. This is required only if REST API is used
* UB_CORE_URL - The URL of the Unbound CORE server. This is required only if REST API is used, for example: `https://unbound-server.com`
## Start EncFS 
To use EncFS with Unbound CORE, Start EncFS Daemon with the password encrypted and generated by Unbound CORE 
```
encfs --extpass="ub-get-password" --standard /your-encrypted-data-folder /your-mounted-data-folder
```

## Key rotation
This solution automatically supports key-rotation.
The encrypted key is stored along with its 

## Demo with Docker
You can see a full demo of this solution with Docker.
You'll need to have [Docker installed](https://docs.docker.com/get-docker/) on your system to run this.
1. Open a bash shell in the `docker` folder
2. Run `docker-compose build && docker-compose run ukc-client`
3. Follow the on-screen instructions

